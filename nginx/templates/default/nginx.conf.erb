user www-data;
worker_processes auto;
worker_rlimit_nofile 32768;
pid /run/nginx.pid;

events {
    worker_connections  <%= @worker_connections %>;
    use                 epoll;
    multi_accept        on;
}

http {

    sendfile                on;
    tcp_nopush              on;
    tcp_nodelay             on;

    client_body_timeout     15s;
    client_header_timeout   15s;
    
    keepalive_timeout       300;
    keepalive_requests      1000;
    types_hash_max_size     2048;
    
    fastcgi_read_timeout    600;
    fastcgi_buffers         128 16k;
    fastcgi_buffer_size     16k;
    
    open_file_cache         max=10000;
    open_file_cache_min_uses 2;
    open_file_cache_errors  on;
    
    server_tokens           off;
    
    resolver                1.0.0.1                    1.1.1.1
                            208.67.222.222             208.67.220.220
                            8.8.8.8                    8.8.4.4
                            valid=30s                  ipv6=off;
    
    ##
    # Logging Settings
    ##
    log_format  main        '"$upstream" $remote_addr - $remote_user [$time_local] '
                            '"$host" "$request" "$http_accept" '
                            '$status $body_bytes_sent "$http_referer" '
                            '"$http_user_agent" "$http_x_forwarded_for" '
                            '$request_time $upstream_response_time $pipe';
    
    access_log              /var/log/nginx/access.log main buffer=64k flush=30s;
    error_log               /var/log/nginx/error.log warn;
    
    map $request_uri $loggable {
        ~*^/thisthingisnotathing 0;
        ~*^/nginx                0;
        ~*^/status(.php)?        0;
        ~*^/fpm(-ping)?          0;
        ~*^/v1                   0;
        default                  1;
    }
    
    ##
    # AWS Instances
    ##
    # Hydra
    set_real_ip_from        34.199.251.151;
    set_real_ip_from        34.204.144.75;
    set_real_ip_from        34.231.185.78;
    set_real_ip_from        34.231.238.143;
    set_real_ip_from        34.233.228.49;
    set_real_ip_from        34.234.165.192;
    set_real_ip_from        52.44.129.193;
    # Mesh
    set_real_ip_from        34.232.35.154;
    set_real_ip_from        54.174.129.156;
    set_real_ip_from        54.175.57.137;
    # Processing
    set_real_ip_from        54.174.39.211;
    set_real_ip_from        54.175.48.31;
    set_real_ip_from        54.86.13.90;
    
    ##
    # Private Address Space (AWS/Internal)
    ##
    set_real_ip_from        10.0.0.0/8;
    set_real_ip_from        127.0.0.1/32;
    set_real_ip_from        172.16.0.0/12;
    set_real_ip_from        192.168.0.0/16;
    set_real_ip_from        fd00::/8;
    
    ##
    # CloudFlare
    ##
    set_real_ip_from        103.21.244.0/22;
    set_real_ip_from        103.22.200.0/22;
    set_real_ip_from        103.31.4.0/22;
    set_real_ip_from        104.16.0.0/12;
    set_real_ip_from        108.162.192.0/18;
    set_real_ip_from        131.0.72.0/22;
    set_real_ip_from        141.101.64.0/18;
    set_real_ip_from        162.158.0.0/15;
    set_real_ip_from        172.64.0.0/13;
    set_real_ip_from        173.245.48.0/20;
    set_real_ip_from        188.114.96.0/20;
    set_real_ip_from        190.93.240.0/20;
    set_real_ip_from        197.234.240.0/22;
    set_real_ip_from        198.41.128.0/17;
    set_real_ip_from        2400:cb00::/32;
    set_real_ip_from        2405:8100::/32;
    set_real_ip_from        2405:b500::/32;
    set_real_ip_from        2606:4700::/32;
    set_real_ip_from        2803:f800::/32;
    set_real_ip_from        2c0f:f248::/32;
    set_real_ip_from        2a06:98c0::/29;
    
    real_ip_header          X-Forwarded-For;
    real_ip_recursive       on;
    
    ##
    # Zones
    ##
    limit_conn_zone         $binary_remote_addr$real_x_forwarded_for$host$uri$arg_sid$arg_hid$arg_transid$arg_md5
                                zone=conn_limit_per_ip:50m;
    limit_conn_zone         $upstream zone=conn_limit_per_upstream:1m;
    limit_req_zone          $binary_remote_addr$real_x_forwarded_for$host$uri$arg_sid$arg_hid$arg_transid$arg_md5$arg_redirects$arg_retries 
                                zone=force_cookie_reuse:50m rate=12r/m;
    
    ##
    # Scheme Detection
    ##
    map $http_x_forwarded_proto $real_scheme {
        ''                  $scheme;
        default             $scheme;
        https               https;
        http                http;
    }
    
    map $real_scheme $is_https {
        default             '';
        https               on;
    }
    
    ##
    # Gzip Settings
    ##
    gzip_vary               off;
    gzip_min_length         1024;
    gzip_proxied            expired no-cache no-store private auth;
    gzip_types              text/plain text/css text/xml text/javascript application/x-javascript application/xml;
    gzip_disable            "MSIE [1-6]\.";
    
    ##
    # Banned user agents
    ##
    map $http_user_agent $block_ua {
        default             0;
        '~*Jorgee'          1;
        'Mozilla/5.0'       1;
        'Mozilla/4.0 (compatible; Synapse)' 1;
    }
    
    ##
    # Virtual Host Configs
    ##
    include                 /etc/nginx/mime.types;
    default_type            text/plain;
    
    include                 /etc/nginx/conf.d/*.conf;
    include                 /etc/nginx/sites-enabled/*;
}
